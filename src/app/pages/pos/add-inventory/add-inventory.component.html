<div class="container py-4 bg-light shadow-sm classic-box rounded border">
  <div class="mb-4 p-3  bg-white classic-box1">
    <h6 class="mb-3 small text-muted">๐งพ ูุนูููุงุช ุงูุนููู / Client Info</h6>
    <div class="ml-3 row g-3 small d-flex justify-content-evenly">

      <!-- Selling Shop -->
      <div class=" mr-3 mt-2">
        <label class="form-label">ุงููุญู ุงูุจุงุฆุน / Selling Shop</label>
        <div class="input-group">
          <select class="form-select form-control small text-muted" [(ngModel)]="shopId"
            (ngModelChange)="onShopChange()" [disabled]="isViewMode">
            <option *ngFor="let item of shops" [value]="item.id">{{ item.shopName }}</option>
          </select>
          <button class="btn btn-outline-secondary small text-muted" type="button" (click)="clearShop()"
            [disabled]="isViewMode">ร</button>
        </div>
      </div>

      <!-- Client Name -->
      <div class="mr-3 mt-2">
        <label class="form-label">ุงุณู ุงูุนููู / Client Name</label>
        <div class="input-group">
          <select class="form-select form-control small text-muted" [(ngModel)]="supplierId"
            (ngModelChange)="onClientChange($event)" [disabled]="isViewMode">
            <option *ngFor="let item of supplier" [value]="item.id">{{ item.name }}</option>
          </select>
          <button class="btn btn-outline-secondary small text-muted" type="button" (click)="clearClient()"
            [disabled]="isViewMode">ร</button>
        </div>
      </div>

      <!-- PO Number -->
      <div class="mr-3 mt-2">
        <label class="form-label">ุฑูู ุงูุทูุจ / Supplier Invoice No.</label>
        <div class="input-group">
          <input type="text" class="form-control small text-muted" [(ngModel)]="supplierInvoiceNo"
            [disabled]="isViewMode" />
          <!-- <button class="btn btn-outline-secondary" type="button" (click)="form.patchValue({ supplierInvoiceNo: '' })">ร</button> -->
        </div>
      </div>

      <!-- Client Address -->
      <div class="mr-3 mt-2">
        <label class="form-label">ุนููุงู ุงูุนููู / Client Address</label>
        <input class="form-control small text-muted" [value]="address" readonly />
      </div>

      <!-- Date -->
      <div class="mr-3 mt-2">
        <label class="form-label">ุงูุชุงุฑูุฎ ูุงูููุช / Date & Time</label>
        <div class="input-group">
          <input type="date" class="form-control small text-muted" [(ngModel)]="purchaseDate" [disabled]="isViewMode" />
        </div>
      </div>


    </div>
  </div>



  <!-- ๐งบ Item Selection -->
  <div class="mb-4 p-3  bg-white  classic-box1">
    <h6 class="mb-3 small text-muted" *ngIf="!isViewMode">๐งบ ุงุฎุชูุงุฑ ุงูุตูู / Item Selection</h6>
    <div class="row" *ngIf="!isViewMode">
      <div class="col-md-4">
        <!-- <label class="form-label small text-muted">ุงูุตูู / Select Item</label> -->
        <button nbButton status="basic" class="small text-muted " appearance="outline" size="medium"
          (click)="openStockSelector()">
          ุงุฎุชุฑ ุงูุตูู / Choose Item
        </button>
      </div>
    </div>




    <!-- Table -->
    <div class="table-responsive mt-3">
      <table class="table table-bordered table-sm text-center" style="border-color: #ccc; font-size: 0.85rem;">
        <thead class="table-light">
          <tr>
            <th class="small text-muted">ุงูุตูู / Item</th>
            <th class="small text-muted">ุงูุฑูู ุงูุชุณูุณูู / Stock Move ID</th>
            <th class="small text-muted">ุฑูู ุงูุฏูุนุฉ / Batch No</th>
            <th class="small text-muted">ุงูุฑู / Rack</th>
            <th class="small text-muted">ุณุนุฑ ุงูุดุฑุงุก / Buy Price</th>
            <th class="small text-muted">ุฃูู ุณุนุฑ / Min Sale Price</th>
            <th class="small text-muted">ุงูุณุนุฑ ุงูุชุฌุฒุฆุฉ / Retail Price</th>
            <th class="small text-muted">ุณุนุฑ ุงูุจูุน / Selling</th>
            <th class="small text-muted">ุงููููุฉ / Qty</th>
            <th class="small text-muted">ุงููุฎุฒูู / Stock</th>
            <th class="small text-muted">ุงูุถุฑูุจุฉ / VAT</th>
            <th class="small text-muted">ุงูุฎุตู % / Discount %</th>
            <th class="small text-muted">ุงูุฅุฌูุงูู / Total</th>
            <th class="small text-muted">ุงูุงุณุชุฑุงุชูุฌูุฉ / Strategy</th>
            <th class="small text-muted">ููุงุญุธุงุช / Comments</th>
            <th class="small text-muted">๐๏ธ</th>
          </tr>
        </thead>
        <tbody *ngFor="let selectedItem of selectedProduct; let i = index">
          <tr>
            <td class="small text-muted">{{ selectedItem?.product?.name }}</td>
            <td class="small text-muted">{{ selectedItem.stockMovementId }}</td>
            <td class="small text-muted">{{ selectedItem.batchNo }}</td>
            <td class="small text-muted">{{ selectedItem.storageRack }}</td>
            <td class="small text-muted">{{ selectedItem.buyPrice }}</td>
            <td class="small text-muted">{{ selectedItem.minSalePrice }}</td>
            <td class="small text-muted">{{ selectedItem.retailPrice }}</td>

            <td class="small text-muted">
              <input type="number" class="form-control small text-muted" [disabled]="isViewMode"
                [(ngModel)]="selectedItem.sellingPrice" (ngModelChange)="recalculateOverallTotals()" />
            </td>

            <td class="small text-muted">
              <div class="d-flex justify-content-center align-items-center">
                <button nbButton size="tiny" class="small text-muted" status="basic" appearance="outline"
                  (click)="decrementQuantity(selectedItem)" [disabled]="isViewMode">โ</button>
                <input type="number" [disabled]="isViewMode" [(ngModel)]="selectedItem.quantity" [min]="1"
                  class="form-control mx-2 text-center small text-muted" style="width: 60px;"
                  (ngModelChange)="recalculateOverallTotals()" />
                <button nbButton size="tiny" class="small text-muted" status="basic" appearance="outline"
                  (click)="incrementQuantity(selectedItem)" [disabled]="isViewMode">+</button>
              </div>
            </td>

            <td class="small text-muted">{{ selectedItem?.product?.stockQty }}</td>
            <td class="small text-muted">{{ selectedItem.vatAmount }}</td>

            <td class="small text-muted">
              <input type="number" class="form-control small text-muted" [(ngModel)]="selectedItem.discount"
                (ngModelChange)="recalculateOverallTotals()" [disabled]="isViewMode" />
            </td>

            <td class="small text-muted">{{ getLineTotal(selectedItem) }}</td>
            <td class="small text-muted">{{ selectedItem.pricingStrategy }}</td>
            <td class="small text-muted">{{ selectedItem.comments }}</td>

            <td>
              <button nbButton size="tiny" [disabled]="isViewMode" status="danger" (click)="removeItem(i)">
                <i class="nb-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- ๐ฐ Summary Section -->
  <div class="row">
    <div class="col-md-6 offset-md-6">
      <div class="p-3 bg-light  rounded  classic-box1">
        <h6 class="mb-3 small text-muted">๐ฐ ุงูููุฎุต / Summary</h6>
        <div class="ml-3 row g-3 small d-flex justify-content-evenly">
          <div class=" mr-3 mt-2">
            <label class="form-label">Bulk Discount</label>
            <input class="small form-control text-muted" type="number" [disabled]="isViewMode"
              [(ngModel)]="bulkDiscount" (ngModelChange)="recalculateOverallTotals()" />
          </div>
          <div class="mr-3 mt-2">
            <label class="form-label">Tax 15%</label>
            <input class="small form-control text-muted" type="text" [(ngModel)]="totalVatTax" readonly />
          </div>
          <div class="mr-3 mt-2">
            <label class="form-label">Total (Ex. tax)</label>
            <input class="small form-control text-muted" type="text" [(ngModel)]="totalWithoutVat" readonly />
          </div>
          <div class="mr-3 mt-2">
            <label class="form-label fw-bold">Total</label>
            <input class="fw-bold small form-control text-muted" type="text" [disabled]="isViewMode" [(ngModel)]="total"
              (ngModelChange)="onTotalChanged()" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ๐ณ Payment Section -->
  <div class="ml-3 mb-4 p-3 bg-white classic-box1">
    <h6 class="mb-3 text-muted small">๐ณ ุงูุฏูุน / Payment</h6>

    <label class="form-label text-muted small">ุทุฑููุฉ ุงูุฏูุน / Payment Mode</label>

    <div class="d-flex flex-wrap gap-3">

      <!-- Cash Option -->
      <div class="form-check mr-3 mt-2">
        <input class="form-check-input" type="radio" [disabled]="isViewMode" name="paymentMode" id="paymentCash"
          value="Cash" [(ngModel)]="paymentMode" />
        <label class="form-check-label text-muted small" for="paymentCash">
          Cash / ููุฏุงู
        </label>
      </div>

      <!-- Bank Option -->
      <div class="form-check mr-3 mt-2">
        <input class="form-check-input" type="radio" [disabled]="isViewMode" name="paymentMode" id="paymentBank"
          value="Bank" [(ngModel)]="paymentMode" />
        <label class="form-check-label text-muted small" for="paymentBank">
          Bank / ุชุญููู
        </label>
      </div>

      <!-- Credit Option -->
      <div class="form-check mr-3 mt-2">
        <input class="form-check-input" type="radio" [disabled]="isViewMode" name="paymentMode" id="paymentCredit"
          value="Credit" [(ngModel)]="paymentMode" />
        <label class="form-check-label text-muted small" for="paymentCredit">
          Credit / ุขุฌู
        </label>
      </div>
    </div>

    <!-- Cash Details -->
    <div *ngIf="paymentMode === 'Cash'" class="mt-3 col-md-4">
      <label class="form-label small text-muted">Received Amount / ุงููุจูุบ ุงููุณุชูู</label>
      <input type="number" class="form-control form-control-sm" [disabled]="isViewMode" [(ngModel)]="cashReceived"
        name="cashReceived" />
    </div>

    <!-- Bank Details -->
    <!-- <div *ngIf="paymentMode === 'Bank'" class="mt-3 col-md-4">
      <label class="form-label small text-muted">Bank Name / ุงุณู ุงูุจูู</label>
      <input type="text" class="form-control form-control-sm mb-2" [(ngModel)]="form.value.bankName" name="bankName" />
      <label class="form-label small text-muted">Transaction ID / ุฑูู ุงูุนูููุฉ</label>
      <input type="text" class="form-control form-control-sm" [(ngModel)]="form.value.bankTransactionId"
        name="bankTransactionId" />
    </div> -->

    <!-- Credit Details -->
    <!-- <div *ngIf="paymentMode === 'Credit'" class="mt-3 col-md-4">
      <label class="form-label small text-muted">Due Date / ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
      <input type="date" class="form-control form-control-sm" [(ngModel)]="form.value.dueDate" name="dueDate" />
    </div> -->
  </div>



  <!-- Submit -->
  <button (click)="submitSale()" *ngIf="!isViewMode" nbButton status="basic" class="small text-muted ml-5"
    appearance="outline" size="medium">
    ๐พ ุญูุธ ุงููุงุชูุฑุฉ / Save Purchase
  </button>

  <button (click)="goBack()" *ngIf="isViewMode" nbButton status="basic" class="small text-muted ml-5"
    appearance="outline" size="medium">
    Back
  </button>

</div>